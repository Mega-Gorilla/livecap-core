name: Integration Tests

on:
  workflow_dispatch:
  schedule:
    - cron: "0 3 * * 1"  # Weekly on Mondays at 03:00 UTC

jobs:
  transcription-pipeline:
    strategy:
      fail-fast: false
      matrix:
        # Include both hosted and self-hosted runners
        # Windows self-hosted is optional/experimental for now, so we can comment it out or keep it if ready.
        # Based on requirements, we enable self-hosted.
        os: [ubuntu-latest, [self-hosted, linux], [self-hosted, windows]]
        
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        if: matrix.os == 'ubuntu-latest'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up uv
        uses: astral-sh/setup-uv@v3

      - name: Cache ffmpeg-bin
        uses: actions/cache@v4
        with:
          path: ffmpeg-bin
          key: ffmpeg-bin-${{ runner.os }}-${{ hashFiles('.github/actions/setup-livecap-ffmpeg/action.yml') }}
          restore-keys: |
            ffmpeg-bin-${{ runner.os }}-

      - name: Setup LiveCap FFmpeg
        uses: ./.github/actions/setup-livecap-ffmpeg
        with:
          ffmpeg-bin-dir: 'ffmpeg-bin'

      - name: Sync dependencies
        run: uv sync --extra translation --extra dev --extra engines-torch

      - name: Run integration tests
        env:
          # Python handles forward slashes on all platforms
          LIVECAP_FFMPEG_BIN: "${{ github.workspace }}/ffmpeg-bin"
        run: |
          uv run python -m pytest tests/integration -m "not engine_smoke"

  engine-smoke-cpu:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up uv
        uses: astral-sh/setup-uv@v3

      - name: Cache ffmpeg-bin
        uses: actions/cache@v4
        with:
          path: ffmpeg-bin
          key: ffmpeg-bin-${{ runner.os }}-${{ hashFiles('.github/actions/setup-livecap-ffmpeg/action.yml') }}
          restore-keys: |
            ffmpeg-bin-${{ runner.os }}-

      - name: Setup LiveCap FFmpeg
        uses: ./.github/actions/setup-livecap-ffmpeg
        with:
          ffmpeg-bin-dir: 'ffmpeg-bin'

      - name: Sync dependencies
        run: uv sync --extra translation --extra dev --extra engines-torch

      - name: Debug shared libraries
        run: |
          SITE_PACKAGES=$(uv run python -c "import site; print(site.getsitepackages()[0])")
          SHERPA_LIB="$SITE_PACKAGES/sherpa_onnx/lib"
          
          echo "Listing $SHERPA_LIB:"
          ls -l "$SHERPA_LIB" || echo "Directory not found"
          
          echo "Checking dependencies of _sherpa_onnx extension:"
          EXT_MOD=$(find "$SITE_PACKAGES/sherpa_onnx" -name "_sherpa_onnx*.so" | head -n 1)
          if [ -n "$EXT_MOD" ]; then
            echo "Target: $EXT_MOD"
            ldd "$EXT_MOD"
          else
            echo "Extension module not found!"
          fi

      - name: Warm engine caches (CPU)
        env:
          LIVECAP_FFMPEG_BIN: "${{ github.workspace }}/ffmpeg-bin"
        run: |
          # Ensure we are using the correct onnxruntime version within THIS uv environment
          echo "Forcing onnxruntime==1.17.1 installation..."
          uv pip install onnxruntime==1.17.1
          
          # Robustly find libonnxruntime.so via python site-packages
          SITE_PACKAGES=$(uv run python -c "import site; print(site.getsitepackages()[0])")
          echo "Site packages: $SITE_PACKAGES"
          
          # Search for the actual shared library
          echo "Searching for libonnxruntime.so in site-packages..."
          LIB_PATH=$(find "$SITE_PACKAGES" -name "libonnxruntime.so*" | head -n 1)
          
          if [ -n "$LIB_PATH" ]; then
             LIB_DIR=$(dirname "$LIB_PATH")
             echo "Found libonnxruntime at: $LIB_PATH"
             
             # Create symlink if strict filename is missing (sherpa needs libonnxruntime.so)
             if [ ! -f "$LIB_DIR/libonnxruntime.so" ]; then
                 echo "Creating symlink: libonnxruntime.so -> $(basename "$LIB_PATH")"
                 ln -sf "$(basename "$LIB_PATH")" "$LIB_DIR/libonnxruntime.so"
             fi
             
             echo "Setting LD_LIBRARY_PATH to: $LIB_DIR"
             export LD_LIBRARY_PATH="$LIB_DIR:$LD_LIBRARY_PATH"
          else
             echo "ERROR: libonnxruntime.so not found anywhere in site-packages."
             ls -F "$SITE_PACKAGES" || true
          fi

          uv run python - <<'PY'
          import onnxruntime
          print(f"Runtime ORT version: {onnxruntime.__version__}")
          
          from engines.engine_factory import EngineFactory
          from livecap_core.config.defaults import get_default_config

          def warm(engine_type: str, device: str, lang: str) -> None:
              cfg = get_default_config()
              transcription = cfg["transcription"]
              transcription["engine"] = engine_type
              transcription["input_language"] = lang
              engine = EngineFactory.create_engine(
                  engine_type=engine_type,
                  device=device,
                  config=cfg,
              )
              engine.load_model()
              models_dir = engine.model_manager.get_models_dir(engine.engine_name)
              print(f"[{engine_type}/{device}] cached at: {models_dir}")

          warm("reazonspeech", "cpu", "ja")
          warm("whispers2t_base", "cpu", "en")
          PY

      - name: Run engine smoke tests (CPU)
        env:
          LIVECAP_FFMPEG_BIN: "${{ github.workspace }}/ffmpeg-bin"
          LIVECAP_REQUIRE_ENGINE_SMOKE: ${{ vars.LIVECAP_REQUIRE_ENGINE_SMOKE }}
        run: |
          uv run python -m pytest tests/integration/engines -m "engine_smoke and not gpu"

  engine-smoke-gpu:
    if: vars.LIVECAP_ENABLE_GPU_SMOKE == '1'
    strategy:
      fail-fast: false
      matrix:
        os: [[self-hosted, linux], [self-hosted, windows]]

    runs-on: ${{ matrix.os }}

    env:
      LIVECAP_ENABLE_GPU_SMOKE: ${{ vars.LIVECAP_ENABLE_GPU_SMOKE }}
      LIVECAP_REQUIRE_ENGINE_SMOKE: ${{ vars.LIVECAP_REQUIRE_ENGINE_SMOKE }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Set up Python (Linux)
        if: matrix.os == '[self-hosted, linux]'
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Use preinstalled Python (Windows)
        if: matrix.os == '[self-hosted, windows]'
        shell: pwsh
        run: |
          $python = Get-Command python3.12 | Select-Object -ExpandProperty Source
          if (-not $python) { throw "python3.12 not found on runner" }
          Write-Host "Using python at $python"
          "PYTHON_EXE=$python" | Out-File -FilePath $Env:GITHUB_ENV -Encoding utf8 -Append

      - name: Set up uv
        uses: astral-sh/setup-uv@v3

      - name: Cache ffmpeg-bin
        uses: actions/cache@v4
        with:
          path: ffmpeg-bin
          key: ffmpeg-bin-${{ runner.os }}-${{ hashFiles('.github/actions/setup-livecap-ffmpeg/action.yml') }}
          restore-keys: |
            ffmpeg-bin-${{ runner.os }}-

      - name: Setup LiveCap FFmpeg
        uses: ./.github/actions/setup-livecap-ffmpeg
        with:
          ffmpeg-bin-dir: 'ffmpeg-bin'

      - name: Sync dependencies (Linux)
        if: matrix.os == '[self-hosted, linux]'
        shell: bash
        run: |
          uv sync --extra translation --extra dev --extra engines-torch --extra engines-nemo

      - name: Sync dependencies (Windows)
        if: matrix.os == '[self-hosted, windows]'
        shell: pwsh
        run: |
          uv python pin "$Env:PYTHON_EXE"
          uv sync --extra translation --extra dev --extra engines-torch --extra engines-nemo

      - name: Warm engine caches (GPU / self-hosted, Linux)
        if: matrix.os == '[self-hosted, linux]'
        shell: bash
        env:
          LIVECAP_FFMPEG_BIN: "${{ github.workspace }}/ffmpeg-bin"
        run: |
          uv run python - <<'PY'
          from engines.engine_factory import EngineFactory
          from livecap_core.config.defaults import get_default_config

          def warm(engine_type: str, device: str, lang: str) -> None:
              cfg = get_default_config()
              transcription = cfg["transcription"]
              transcription["engine"] = engine_type
              transcription["input_language"] = lang
              engine = EngineFactory.create_engine(
                  engine_type=engine_type,
                  device=device,
                  config=cfg,
              )
              engine.load_model()
              models_dir = engine.model_manager.get_models_dir(engine.engine_name)
              print(f"[{engine_type}/{device}] cached at: {models_dir}")

          warm("whispers2t_base", "cuda", "en")
          warm("parakeet", "cuda", "en")
          PY

      - name: Warm engine caches (GPU / self-hosted, Windows)
        if: matrix.os == '[self-hosted, windows]'
        shell: pwsh
        env:
          LIVECAP_FFMPEG_BIN: "${{ github.workspace }}/ffmpeg-bin"
        run: |
          uv python pin "$Env:PYTHON_EXE"
          uv run python - <<'PY'
          from engines.engine_factory import EngineFactory
          from livecap_core.config.defaults import get_default_config

          def warm(engine_type: str, device: str, lang: str) -> None:
              cfg = get_default_config()
              transcription = cfg["transcription"]
              transcription["engine"] = engine_type
              transcription["input_language"] = lang
              engine = EngineFactory.create_engine(
                  engine_type=engine_type,
                  device=device,
                  config=cfg,
              )
              engine.load_model()
              models_dir = engine.model_manager.get_models_dir(engine.engine_name)
              print(f"[{engine_type}/{device}] cached at: {models_dir}")

          warm("whispers2t_base", "cuda", "en")
          warm("parakeet", "cuda", "en")
          PY

      - name: Run engine smoke tests (GPU / self-hosted, Linux)
        if: matrix.os == '[self-hosted, linux]'
        shell: bash
        env:
          LIVECAP_FFMPEG_BIN: "${{ github.workspace }}/ffmpeg-bin"
          LIVECAP_ENABLE_GPU_SMOKE: ${{ vars.LIVECAP_ENABLE_GPU_SMOKE }}
          LIVECAP_REQUIRE_ENGINE_SMOKE: ${{ vars.LIVECAP_REQUIRE_ENGINE_SMOKE }}
        run: |
          uv run python -m pytest tests/integration/engines -m "engine_smoke and gpu"

      - name: Run engine smoke tests (GPU / self-hosted, Windows)
        if: matrix.os == '[self-hosted, windows]'
        shell: pwsh
        env:
          LIVECAP_FFMPEG_BIN: "${{ github.workspace }}/ffmpeg-bin"
          LIVECAP_ENABLE_GPU_SMOKE: ${{ vars.LIVECAP_ENABLE_GPU_SMOKE }}
          LIVECAP_REQUIRE_ENGINE_SMOKE: ${{ vars.LIVECAP_REQUIRE_ENGINE_SMOKE }}
        run: |
          uv python pin "$Env:PYTHON_EXE"
          uv run python -m pytest tests/integration/engines -m "engine_smoke and gpu"
