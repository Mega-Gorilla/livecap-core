name: Verify Self-Hosted Linux Runner
on:
  workflow_dispatch:

jobs:
  verify-environment:
    runs-on: [self-hosted, linux]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup FFmpeg for LiveCap
        run: |
          echo "Setting up FFmpeg in ./ffmpeg-bin..."
          mkdir -p ffmpeg-bin
          
          # Locate system ffmpeg
          FFMPEG_PATH=$(which ffmpeg)
          FFPROBE_PATH=$(which ffprobe)
          
          if [ -z "$FFMPEG_PATH" ]; then
            echo "FFmpeg not found! Downloading portable binaries..."
            
            # Create temp workspace
            WORK_DIR="temp_ffmpeg_install"
            mkdir -p "$WORK_DIR"
            
            # Download ffmpeg
            echo "Downloading ffmpeg..."
            curl -L -o "$WORK_DIR/ffmpeg.zip" "https://github.com/ffbinaries/ffbinaries-prebuilt/releases/download/v6.1/ffmpeg-6.1-linux-64.zip"
            unzip -o "$WORK_DIR/ffmpeg.zip" -d "$WORK_DIR/ffmpeg_out"
            mv "$WORK_DIR/ffmpeg_out/ffmpeg" ffmpeg-bin/
            
            # Download ffprobe
            echo "Downloading ffprobe..."
            curl -L -o "$WORK_DIR/ffprobe.zip" "https://github.com/ffbinaries/ffbinaries-prebuilt/releases/download/v6.1/ffprobe-6.1-linux-64.zip"
            unzip -o "$WORK_DIR/ffprobe.zip" -d "$WORK_DIR/ffprobe_out"
            mv "$WORK_DIR/ffprobe_out/ffprobe" ffmpeg-bin/
            
            # Cleanup
            rm -rf "$WORK_DIR"
            
            # Set permissions
            chmod +x ffmpeg-bin/ffmpeg ffmpeg-bin/ffprobe
            
            # Set paths for the log output below
            FFMPEG_PATH="ffmpeg-bin/ffmpeg"
            FFPROBE_PATH="ffmpeg-bin/ffprobe"
          else
              echo "Copying from $FFMPEG_PATH and $FFPROBE_PATH"
              cp "$FFMPEG_PATH" ffmpeg-bin/
              cp "$FFPROBE_PATH" ffmpeg-bin/
          fi
          
          echo "Listing ffmpeg-bin:"
          ls -l ffmpeg-bin/

      - name: Verify FFmpeg Resolution via ENV
        env:
          LIVECAP_FFMPEG_BIN: ${{ github.workspace }}/ffmpeg-bin
        run: |
          echo "Testing FFmpeg resolution with LIVECAP_FFMPEG_BIN=$LIVECAP_FFMPEG_BIN"
          
          # Simulate how the app finds the binary
          if [ -f "$LIVECAP_FFMPEG_BIN/ffmpeg" ]; then
            echo "SUCCESS: Found ffmpeg binary at expected path."
            "$LIVECAP_FFMPEG_BIN/ffmpeg" -version | head -n 1
          else
            echo "FAILURE: ffmpeg binary not found in LIVECAP_FFMPEG_BIN location."
            exit 1
          fi

      - name: Check Other Tools
        run: |
          echo "=== Tool Versions ==="
          echo "Python: $(python3 --version 2>&1 || echo 'Not found')"
          
          # Check for uv
          if ! command -v uv &> /dev/null; then
               if [ -f "$HOME/.cargo/bin/uv" ]; then export PATH="$HOME/.cargo/bin:$PATH"; fi
          fi
          echo "uv: $(uv --version 2>&1 || echo 'Not found')"
